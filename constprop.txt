#include <stdio.h>
#include <string.h>
#include <stdbool.h>
#include <stdlib.h>

typedef struct {
    char op[10];
    char arg1[10];
    char arg2[10];
    char result[10];
} Instruction;

typedef struct {
    char variable[10];
    int value;
    bool is_const;
} Symbol;

bool is_number(const char* str) {
    if (str == NULL || *str == '\0') {
        return false;
    }
    char* end;
    strtol(str, &end, 10);
    return *end == '\0';
}

bool find_const_value(const char* var, Symbol* table, int table_size, int* value) {
    for (int i = 0; i < table_size; i++) {
        if (strcmp(table[i].variable, var) == 0 && table[i].is_const) {
            *value = table[i].value;
            return true;
        }
    }
    return false;
}

void update_symbol_table(const char* var, int value, bool is_const, Symbol* table, int* table_size) {
    int index = -1;
    for (int i = 0; i < *table_size; i++) {
        if (strcmp(table[i].variable, var) == 0) {
            index = i;
            break;
        }
    }

    if (index != -1) {
        table[index].value = value;
        table[index].is_const = is_const;
    } else {
        strcpy(table[*table_size].variable, var);
        table[*table_size].value = value;
        table[*table_size].is_const = is_const;
        (*table_size)++;
    }
}

void print_instructions(Instruction* instructions, int count, const char* header) {
    printf("\n--- %s ---\n", header);
    for (int i = 0; i < count; i++) {
        if (strcmp(instructions[i].op, "=") == 0) {
            printf("%s = %s\n", instructions[i].result, instructions[i].arg1);
        } else {
            printf("%s = %s %s %s\n", instructions[i].result,
                   instructions[i].arg1,
                   instructions[i].op,
                   instructions[i].arg2);
        }
    }
    printf("\n");
}

int main() {
    Instruction instructions[100];
    int num_instructions = 0;

    printf("Enter the number of instructions: ");
    char input_line[10];
    if (fgets(input_line, sizeof(input_line), stdin)) {
        num_instructions = atoi(input_line);
    }

    // Read the instructions
    for (int i = 0; i < num_instructions; i++) {
        printf("Instruction %d: ", i + 1);
        char line[100];
        if (!fgets(line, sizeof(line), stdin)) {
            printf("Error reading instruction. Aborting.\n");
            return 1;
        }

        int items = sscanf(line, "%9s = %9s %9s %9s",
                           instructions[i].result,
                           instructions[i].arg1,
                           instructions[i].op,
                           instructions[i].arg2);

        if (items == 4) {
            // ok - op is arithmetic
        } else if (items == 2) {
            strcpy(instructions[i].op, "=");
            strcpy(instructions[i].arg2, "");
        } else {
            printf("Invalid instruction format. Please try again.\n");
            i--;
            continue;
        }
    }

    Instruction optimized_instructions[100];
    memcpy(optimized_instructions, instructions, sizeof(Instruction) * num_instructions);

    Symbol symbol_table[20];
    int symbol_table_size = 0;

    print_instructions(instructions, num_instructions, "Original Code");

    // Constant propagation pass
    for (int i = 0; i < num_instructions; i++) {
        int temp_val;

        // Check arg1
        if (!is_number(optimized_instructions[i].arg1)) {
            if (find_const_value(optimized_instructions[i].arg1, symbol_table, symbol_table_size, &temp_val)) {
                sprintf(optimized_instructions[i].arg1, "%d", temp_val);
            }
        }

        // Check arg2
        if (strlen(optimized_instructions[i].arg2) > 0 && !is_number(optimized_instructions[i].arg2)) {
            if (find_const_value(optimized_instructions[i].arg2, symbol_table, symbol_table_size, &temp_val)) {
                sprintf(optimized_instructions[i].arg2, "%d", temp_val);
            }
        }

        // Update symbol table
        char* op = optimized_instructions[i].op;
        char* arg1 = optimized_instructions[i].arg1;
        char* result = optimized_instructions[i].result;

        if (strcmp(op, "=") == 0 && is_number(arg1)) {
            update_symbol_table(result, atoi(arg1), true, symbol_table, &symbol_table_size);
        } else {
            update_symbol_table(result, 0, false, symbol_table, &symbol_table_size);
        }
    }

    print_instructions(optimized_instructions, num_instructions, "After Constant Propagation");
    return 0;
}
